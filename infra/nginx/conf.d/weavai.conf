# WEAV AI Nginx 설정
# 리버스 프록시 및 정적 파일 서빙
#
# Docker DNS(127.0.0.11) + 변수 사용: upstream 호스트를 요청 시점에 조회.
# 설정 로드 시 api 미존재해도 "host not found" 로 Nginx 기동 실패 방지.

resolver 127.0.0.11 valid=10s ipv6=off;

# Rate limit zones (defined at http context level via conf.d include)
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=admin:10m rate=2r/s;

server {
    listen 80;
    server_name weavai.hub www.weavai.hub localhost;

    # 클라이언트 요청 크기 제한 (이미지/비디오 업로드 고려)
    client_max_body_size 100m;

    # 기본 보안 헤더
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ===== 헬스체크 엔드포인트 =====
    # Nginx 자체 헬스체크 (외부 모니터링용)
    location /healthz {
        access_log off;
        return 200 "ok\n";
        add_header Content-Type text/plain;
    }

    # ===== API 라우팅 =====
    # 모든 /api/ 요청을 Django 백엔드로 프록시
    # proxy_pass에 변수 사용 → 요청 시마다 api:8000 DNS 조회 (Docker 내부 DNS)
    location /api/ {
        set $api_upstream http://api:8000;

        # Rate limiting for API
        limit_req zone=api burst=20 nodelay;

        # 디버그: Django의 실제 500 에러 바디를 클라이언트에 그대로 전달
        proxy_intercept_errors off;

        # 프록시 설정
        proxy_pass $api_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 타임아웃 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 버퍼링 설정 (대용량 응답 처리)
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    # ===== 정적 파일 서빙 (향후 확장용) =====
    # 현재는 API만 제공하므로 주석 처리
    # location /static/ {
    #     alias /app/staticfiles/;
    #     expires 1y;
    #     add_header Cache-Control "public, immutable";
    #     access_log off;
    # }

    # ===== 기본 리다이렉트 =====
    # API가 아닌 요청은 모두 API로 리다이렉트 (SPA 지원용)
    location / {
        # API 안내 페이지 반환
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>WEAV AI API</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        h1 { color: #2563eb; }
        .endpoint { background: #f3f4f6; padding: 10px; margin: 10px 0; border-radius: 5px; }
        code { background: #e5e7eb; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1> WEAV AI API</h1>
    <p>API 서버가 정상적으로 실행 중입니다.</p>
    <h2>주요 엔드포인트:</h2>
    <div class="endpoint">
        <strong>헬스체크:</strong> <code><a href="/api/v1/health/">/api/v1/health/</a></code>
    </div>
    <div class="endpoint">
        <strong>인증:</strong> <code>/api/v1/auth/</code>
    </div>
    <div class="endpoint">
        <strong>작업 관리:</strong> <code>/api/v1/jobs/</code>
    </div>
    <div class="endpoint">
        <strong>스토리지:</strong> <code>/api/v1/storage/</code>
    </div>
    <p style="margin-top: 30px; color: #6b7280; font-size: 0.9em;">
        API Base URL: <code>http://localhost:8080/api/v1/</code>
    </p>
</body>
</html>';
        add_header Content-Type text/html;
    }

    # ===== Admin (IP allowlist + rate limit) =====
    location /admin/ {
        # Tight rate limit for admin
        limit_req zone=admin burst=5 nodelay;

        # IP allowlist (edit infra/nginx/conf.d/admin_allowlist.conf)
        include /etc/nginx/conf.d/admin_allowlist.conf;

        set $api_upstream http://api:8000;
        proxy_pass $api_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ===== 에러 페이지 =====
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
