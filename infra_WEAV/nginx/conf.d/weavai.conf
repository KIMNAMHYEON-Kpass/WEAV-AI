# WEAV AI Nginx ì„¤ì •
# ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ë° ì •ì  íŒŒì¼ ì„œë¹™
#
# Docker DNS(127.0.0.11) + ë³€ìˆ˜ ì‚¬ìš©: upstream í˜¸ìŠ¤íŠ¸ë¥¼ ìš”ì²­ ì‹œì ì— ì¡°íšŒ.
# ì„¤ì • ë¡œë“œ ì‹œ api ë¯¸ì¡´ì¬í•´ë„ "host not found" ë¡œ Nginx ê¸°ë™ ì‹¤íŒ¨ ë°©ì§€.

resolver 127.0.0.11 valid=10s ipv6=off;

server {
    listen 80;
    server_name weavai.hub www.weavai.hub localhost;

    # í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ í¬ê¸° ì œí•œ (ì´ë¯¸ì§€/ë¹„ë””ì˜¤ ì—…ë¡œë“œ ê³ ë ¤)
    client_max_body_size 100m;

    # ê¸°ë³¸ ë³´ì•ˆ í—¤ë”
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ===== í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ =====
    # Nginx ìì²´ í—¬ìŠ¤ì²´í¬ (ì™¸ë¶€ ëª¨ë‹ˆí„°ë§ìš©)
    location /healthz {
        access_log off;
        return 200 "ok\n";
        add_header Content-Type text/plain;
    }

    # ===== API ë¼ìš°íŒ… =====
    # ëª¨ë“  /api/ ìš”ì²­ì„ Django ë°±ì—”ë“œë¡œ í”„ë¡ì‹œ
    # proxy_passì— ë³€ìˆ˜ ì‚¬ìš© â†’ ìš”ì²­ ì‹œë§ˆë‹¤ api:8000 DNS ì¡°íšŒ (Docker ë‚´ë¶€ DNS)
    location /api/ {
        set $api_upstream http://api:8000;

        # ë””ë²„ê·¸: Djangoì˜ ì‹¤ì œ 500 ì—ëŸ¬ ë°”ë””ë¥¼ í´ë¼ì´ì–¸íŠ¸ì— ê·¸ëŒ€ë¡œ ì „ë‹¬
        proxy_intercept_errors off;

        # í”„ë¡ì‹œ ì„¤ì •
        proxy_pass $api_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # íƒ€ì„ì•„ì›ƒ ì„¤ì •
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # ë²„í¼ë§ ì„¤ì • (ëŒ€ìš©ëŸ‰ ì‘ë‹µ ì²˜ë¦¬)
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    # ===== ì •ì  íŒŒì¼ ì„œë¹™ (í–¥í›„ í™•ì¥ìš©) =====
    # í˜„ì¬ëŠ” APIë§Œ ì œê³µí•˜ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬
    # location /static/ {
    #     alias /app/staticfiles/;
    #     expires 1y;
    #     add_header Cache-Control "public, immutable";
    #     access_log off;
    # }

    # ===== ê¸°ë³¸ ë¦¬ë‹¤ì´ë ‰íŠ¸ =====
    # APIê°€ ì•„ë‹Œ ìš”ì²­ì€ ëª¨ë‘ APIë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (SPA ì§€ì›ìš©)
    location / {
        # API ì•ˆë‚´ í˜ì´ì§€ ë°˜í™˜
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>WEAV AI API</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        h1 { color: #2563eb; }
        .endpoint { background: #f3f4f6; padding: 10px; margin: 10px 0; border-radius: 5px; }
        code { background: #e5e7eb; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>ğŸš€ WEAV AI API</h1>
    <p>API ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.</p>
    <h2>ì£¼ìš” ì—”ë“œí¬ì¸íŠ¸:</h2>
    <div class="endpoint">
        <strong>í—¬ìŠ¤ì²´í¬:</strong> <code><a href="/api/v1/health/">/api/v1/health/</a></code>
    </div>
    <div class="endpoint">
        <strong>ì¸ì¦:</strong> <code>/api/v1/auth/</code>
    </div>
    <div class="endpoint">
        <strong>ì‘ì—… ê´€ë¦¬:</strong> <code>/api/v1/jobs/</code>
    </div>
    <div class="endpoint">
        <strong>ìŠ¤í† ë¦¬ì§€:</strong> <code>/api/v1/storage/</code>
    </div>
    <p style="margin-top: 30px; color: #6b7280; font-size: 0.9em;">
        API Base URL: <code>http://localhost:8080/api/v1/</code>
    </p>
</body>
</html>';
        add_header Content-Type text/html;
    }

    # ===== ì—ëŸ¬ í˜ì´ì§€ =====
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /50x.html {
        root /usr/share/nginx/html;
    }
}